/**
 * AP Networking Quiz Dev Tool
 * Copy and paste this entire script into your browser console to highlight correct answers in green.
 * Visual indicator circle shows which answer is correct!
 */

(function() {
  const HIGHLIGHT_COLOR = '#40FF00'; // Neon green from your theme
  const HIGHLIGHT_BG = 'rgba(64, 255, 0, 0.3)'; // Semi-transparent green background
  
  console.log('%c✓ Quiz Dev Tool Loaded', 'color: #40FF00; font-size: 14px; font-weight: bold;');
  console.log('%cA circle in the bottom-right shows which answer is correct!', 'color: #00FFFF; font-size: 12px;');
  
  // Store original styles to restore on reset
  const highlightedElements = new Map();
  
  /**
   * Create and initialize the indicator circle
   */
  function createIndicatorCircle() {
    // Check if already exists
    if (document.getElementById('quiz-dev-indicator')) {
      return;
    }
    
    const circle = document.createElement('div');
    circle.id = 'quiz-dev-indicator';
    circle.style.cssText = `
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: rgba(0, 8, 16, 0.9);
      border: none;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      box-shadow: none;
      pointer-events: auto;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s ease;
    `;
    
    // Create 4 quarters
    const quarters = ['top-left', 'top-right', 'bottom-left', 'bottom-right'];
    quarters.forEach(quarter => {
      const q = document.createElement('div');
      q.className = `indicator-quarter indicator-${quarter}`;
      q.style.cssText = `
        width: 50%;
        height: 50%;
        background: rgba(50, 50, 60, 0.7);
        border: none;
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
        ${quarter === 'top-left' ? 'border-radius: 7px 0 0 0;' : ''}
        ${quarter === 'top-right' ? 'border-radius: 0 7px 0 0;' : ''}
        ${quarter === 'bottom-left' ? 'border-radius: 0 0 0 7px;' : ''}
        ${quarter === 'bottom-right' ? 'border-radius: 0 0 7px 0;' : ''}
        pointer-events: none;
      `;
      circle.appendChild(q);
    });
    
    // Hover effect
    circle.addEventListener('mouseenter', () => {
      circle.style.background = '#FF4444';
      circle.innerHTML = '<span style="color: white; font-size: 12px; font-weight: bold; line-height: 1;">×</span>';
    });
    
    circle.addEventListener('mouseleave', () => {
      circle.style.background = 'rgba(0, 8, 16, 0.9)';
      // Restore the quarters
      circle.innerHTML = '';
      quarters.forEach(quarter => {
        const q = document.createElement('div');
        q.className = `indicator-quarter indicator-${quarter}`;
        q.style.cssText = `
          width: 50%;
          height: 50%;
          background: rgba(50, 50, 60, 0.7);
          border: none;
          transition: background-color 0.3s ease, box-shadow 0.3s ease;
          ${quarter === 'top-left' ? 'border-radius: 7px 0 0 0;' : ''}
          ${quarter === 'top-right' ? 'border-radius: 0 7px 0 0;' : ''}
          ${quarter === 'bottom-left' ? 'border-radius: 0 0 0 7px;' : ''}
          ${quarter === 'bottom-right' ? 'border-radius: 0 0 7px 0;' : ''}
          pointer-events: none;
        `;
        circle.appendChild(q);
      });
      // Restore the highlight if needed
      updateIndicatorCircle();
    });
    
    // Click to close
    circle.addEventListener('click', () => {
      circle.style.display = 'none';
      console.log('%c✓ Indicator circle hidden. Run quizDevTool.show() to bring it back.', 'color: #40FF00; font-size: 12px;');
    });
    
    document.body.appendChild(circle);
  }
  
  /**
   * Update indicator circle based on which answer is correct
   */
  function updateIndicatorCircle() {
    const answerCards = document.querySelectorAll('.answer-card');
    
    if (answerCards.length === 0) return;
    
    // Clear all quarters first
    document.querySelectorAll('.indicator-quarter').forEach(quarter => {
      quarter.style.background = 'rgba(50, 50, 60, 0.7)';
      quarter.style.boxShadow = 'none';
    });
    
    // Get the current question data
    const currentQuestion = getReactState();
    if (!currentQuestion || !currentQuestion.correct) return;
    
    const correctAnswer = currentQuestion.correct;
    
    // Find which position the correct answer is in (0, 1, 2, or 3)
    let correctIndex = -1;
    answerCards.forEach((card, index) => {
      const cardText = card.textContent.trim();
      const correctText = correctAnswer.trim();
      if (cardText === correctText) {
        correctIndex = index;
      }
    });
    
    if (correctIndex === -1) return;
    
    // Map answer positions to quarters
    // Assuming 2x2 grid layout
    const quarterMap = {
      0: 'top-left',
      1: 'top-right',
      2: 'bottom-left',
      3: 'bottom-right'
    };
    
    const targetQuarter = quarterMap[correctIndex];
    if (targetQuarter) {
      const quarterEl = document.querySelector(`.indicator-${targetQuarter}`);
      if (quarterEl) {
        quarterEl.style.background = 'rgba(64, 255, 0, 0.7)';
        quarterEl.style.boxShadow = `inset 0 0 10px rgba(64, 255, 0, 0.8)`;
      }
    }
  }
  
  /**
   * Extract React fiber from DOM element to access component state
   */
  function getReactFiber(element) {
    const key = Object.keys(element).find(key => 
      key.startsWith('__react') || key.startsWith('__reactFiber')
    );
    return key ? element[key] : null;
  }
  
  /**
   * Get React component state from fiber tree
   */
  function getReactState() {
    try {
      const rootElement = document.getElementById('root');
      if (!rootElement) return null;
      
      let fiber = getReactFiber(rootElement);
      if (!fiber) return null;
      
      // Traverse the fiber tree to find the App component
      while (fiber) {
        // Look for currentQuestion in the component's state
        if (fiber.memoizedState) {
          let hookState = fiber.memoizedState;
          let hookIndex = 0;
          
          while (hookState) {
            // Check if this hook contains currentQuestion
            if (hookState.memoizedState && hookState.memoizedState.question) {
              return hookState.memoizedState;
            }
            // Check if this is the shuffledAnswers or other relevant state
            if (Array.isArray(hookState.memoizedState)) {
              // Look ahead for currentQuestion
              let tempState = hookState;
              while (tempState) {
                if (tempState.memoizedState && tempState.memoizedState.question) {
                  return tempState.memoizedState;
                }
                tempState = tempState.next;
              }
            }
            hookState = hookState.next;
            hookIndex++;
          }
        }
        
        // Try the alternate fiber (for Concurrent rendering)
        if (fiber.alternate && fiber.alternate.memoizedState) {
          const altState = fiber.alternate.memoizedState;
          let hookState = altState;
          
          while (hookState) {
            if (hookState.memoizedState && hookState.memoizedState.question) {
              return hookState.memoizedState;
            }
            hookState = hookState.next;
          }
        }
        
        fiber = fiber.child;
      }
    } catch (error) {
      console.error('Error accessing React state:', error);
    }
    return null;
  }
  
  /**
   * Main function to highlight correct answers (before submission)
   */
  function highlightCorrectAnswers() {
    // First, try to find the correct answer from React state
    const currentQuestion = getReactState();
    
    if (!currentQuestion || !currentQuestion.correct) {
      return;
    }
    
    // Update the indicator circle
    updateIndicatorCircle();
  }
  
  /**
   * Apply highlight styling to an element
   */
  function highlightElement(element) {
    if (highlightedElements.has(element)) {
      return; // Already highlighted
    }
    
    // Store original styles
    const originalStyles = {
      color: element.style.color,
      backgroundColor: element.style.backgroundColor,
      boxShadow: element.style.boxShadow,
      border: element.style.border
    };
    
    highlightedElements.set(element, originalStyles);
    
    // Apply highlight styles
    element.style.color = HIGHLIGHT_COLOR;
    element.style.backgroundColor = HIGHLIGHT_BG;
    element.style.boxShadow = `0 0 15px rgba(64, 255, 0, 0.8), inset 0 0 10px rgba(64, 255, 0, 0.3)`;
    element.style.border = `3px solid ${HIGHLIGHT_COLOR}`;
    element.style.fontWeight = 'bold';
    element.style.transition = 'all 0.3s ease';
  }
  
  /**
   * Reset all highlights
   */
  function resetHighlights() {
    highlightedElements.forEach((originalStyles, element) => {
      element.style.color = originalStyles.color;
      element.style.backgroundColor = originalStyles.backgroundColor;
      element.style.boxShadow = originalStyles.boxShadow;
      element.style.border = originalStyles.border;
      element.style.fontWeight = '';
    });
    
    highlightedElements.clear();
    
    // Reset indicator circle
    document.querySelectorAll('.indicator-quarter').forEach(quarter => {
      quarter.style.background = 'rgba(50, 50, 60, 0.7)';
      quarter.style.boxShadow = 'none';
    });
    
    console.log('%c✓ All highlights removed', 'color: #FA37FF; font-size: 12px;');
  }
  
  /**
   * Auto-watch for new questions and highlight answers
   */
  function startAutoWatch() {
    // Check every time the DOM changes or page updates
    const observer = new MutationObserver(() => {
      // Small delay to let React render
      setTimeout(() => {
        highlightCorrectAnswers();
      }, 100);
    });
    
    observer.observe(document.body, {
      childList: true,
      subtree: true,
      attributes: true,
      attributeFilter: ['class', 'style']
    });
    
    // Also check periodically in case mutations are missed
    setInterval(() => {
      highlightCorrectAnswers();
    }, 500);
    
    console.log('%c✓ Auto-watch enabled - indicator circle ready!', 'color: #40FF00; font-size: 12px;');
  }
  
  // Expose functions to global scope for manual use
  window.quizDevTool = {
    highlight: highlightCorrectAnswers,
    reset: resetHighlights,
    autoWatch: startAutoWatch,
    show: function() {
      const circle = document.getElementById('quiz-dev-indicator');
      if (circle) {
        circle.style.display = 'flex';
        console.log('%c✓ Indicator circle shown', 'color: #40FF00; font-size: 12px;');
      }
    },
    hide: function() {
      const circle = document.getElementById('quiz-dev-indicator');
      if (circle) {
        circle.style.display = 'none';
        console.log('%c✓ Indicator circle hidden', 'color: #40FF00; font-size: 12px;');
      }
    },
    version: '2.0'
  };
  
  console.log('%cAvailable commands:', 'color: #00EBFF; font-size: 12px; font-weight: bold;');
  console.log('%cquizDevTool.highlight() - Highlight correct answers now', 'color: #00EBFF; font-size: 12px;');
  console.log('%cquizDevTool.reset() - Remove all highlights', 'color: #00EBFF; font-size: 12px;');
  console.log('%cquizDevTool.show() - Show the indicator circle', 'color: #00EBFF; font-size: 12px;');
  console.log('%cquizDevTool.hide() - Hide the indicator circle', 'color: #00EBFF; font-size: 12px;');
  
  // Create the indicator circle and enable auto-watch
  createIndicatorCircle();
  startAutoWatch();
})();
